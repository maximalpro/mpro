<h1>Авторизация с помощью SSL сертификатов.</h1>

Для работы с ключами  и создания сертификатов будем использовать программу openssl. Она входит практичесвки во все версиию линукс серверов, если же у Вас её по какой-то причине нет, то ставим.
     
<h2>Создание собственного самоподписанного доверенного сертификата.</h2>

Перед самым началом выберем директорию в которой будем хранить БД сертификатов и собственно сертификаты создавтаь где будем.<br>
Я к примеру выбрал такой путь,но вы можте выбрать любой другой - значения тут нет вообще:
<pre><code>#cd /var/ssl-cert</code></pre>

Собственный CA необходим для подписи клиентских сертификатов и для их проверки при авторизации клиента веб-сервером. С помощью приведенной ниже команды создается закрытый ключ и самоподписанный сертификат.

<pre><code># openssl req -new -newkey rsa:1024 -nodes -keyout ca.key -x509 -days 500 \
-subj /C=RU/ST=Perm/L=Perm/O=MyOrg\ Inc/OU=Sale/CN=Ivan/emailAddress=mailadres@maximal.pro \
-out ca.crt</code></pre>
   
Создаються два файла ca.key и ca.crt.<br>
<br>
Рассмотрим параметры при создании сертификата:<br>
<ul>
    <li><b>С</b> - Двухсимвольный код страны (Country).</li>
    <li><b>ST</b> - Название региона/области/края/республики/... (StateName).</li>
    <li><b>L</b> - Название города/поселка/... (Locality Name).</li>
    <li><b>O</b> - Название организации (Organization Name).</li>
    <li><b>OU</b> - Название отдела (Organization Unit).</li>
    <li><b>CN</b> - Имя сертификата, при создании серверных сертификатов используется доменное имя сайта, для клиентских сертификатов может быть использовано что угодно (Common Name). Максимальная длина 64 символа.</li>
    <li><b>emailAddress</b> - почтовый адрес (E-mail address). Максимальная длина 40 символов.</li>
</ul>
<i>Единственный обязательный параметр - это emailAddress, все остальные - необязательные.</i><br>
<br>
<i>
    <b>Примечание:</b><br>
    У меня программа не хотела принимать сертификаты если я указывал разные e-mail в клиентских сертификатах, так что советую всегда пользоваться одним. Причину - незнаю.
</i>
<br>
<br>
Просмотриваем данные закрытого ключа и сертификата командами.<br>
Комманда для ключа:
    <pre><code># openssl rsa -noout -text -in ca.key</code></pre>              
Комманда для сертификата:
    <pre><code># openssl x509 -noout -text -in ca.crt</code></pre>
    
<h2>Создание клиентских сертификатов</h2>

Подготовка конфига и файлов для подписи сертификатов.<br>
Создаем конфиг с именем ca.config:

<pre><code>#nano ca.config</code></pre>

Содержание его такое
<pre><code>[ ca ]
default_ca             = CA_CLIENT       # При подписи сертификатов
# использовать секцию CA_CLIENT

[ CA_CLIENT ]
dir                    = ./db            # Каталог для служебных файлов
certs                  = $dir/certs      # Каталог для сертификатов
new_certs_dir          = $dir/newcerts   # Каталог для новых сертификатов

database               = $dir/index.txt  # Файл с базой данных
# подписанных сертификатов
serial                 = $dir/serial     # Файл содержащий серийный номер
# сертификата
# (в шестнадцатиричном формате)
certificate            = ./ca.crt        # Файл сертификата CA
private_key            = ./ca.key        # Файл закрытого ключа CA

default_days           = 365             # Срок действия подписываемого
# сертификата
default_crl_days       = 7               # Срок действия CRL (см. $4)
default_md             = md5             # Алгоритм подписи

policy                 = policy_anything # Название секции с описанием
# политики в отношении данных
# сертификата

[ policy_anything ]
countryName            = optional        # Код страны - не обязателен
stateOrProvinceName    = optional        # ......
localityName           = optional        # ......
organizationName       = optional        # ......
organizationalUnitName = optional        # ......
commonName             = supplied        # ...... - обязателен
emailAddress           = optional        # ......</code></pre>


Делаем структуру каталогов и файлов, которую описали в конфиге.

<pre><code># mkdir db
# mkdir db/certs
# mkdir db/newcerts
# touch db/index.txt
# echo "01" > db/serial</code></pre>


В файле db/serial система записывает текущий серийный номер подписываемого сертификата в шестнадцатиричном формате.<br>
В файл db/index.txt сохраняются данные о подписываемых сертификатах.


<h3>Создание клиентского закрытого ключа и запроса на сертификат (CSR).</h3>

Для создания подписанного клиентского сертификата предварительно необходимо создать запрос на сертификат, для его последующей подписи.<br>
Впринципе тоже что и при создании самоподписанного CA, но отсутсвует параметр -x509.

<pre><code># openssl req -new -newkey rsa:1024 -nodes -keyout client01.key \
-subj /C=RU/ST=Perm/L=Perm/O=MyOrg\ Inc/OU=Sale/CN=Ivan/emailAddress=mailadres@maximal.pro \
-out client01.csr</code></pre>

Получим два файла client01.key и client01.csr.<br>
Смотрим данные закрытого ключа и запроса на сертификат (CSR) с помощью команд.<br><br>

Для ключа:
        <pre><code># openssl rsa -noout -text -in client01.key</code></pre>
Для сертификата:
        <pre><code># openssl req -noout -text -in client01.csr</code></pre>


<h3>Подпись запроса на сертификат (CSR) с помощью доверенного сертификата (CA).</h3>

При подписи запроса используются параметры заданные в ca.config

    <pre><code># openssl ca -config ca.config -in client01.csr -out client01.crt -batch</code></pre>
	
В результате получим файл клиентского сертификата client01.crt.<br>
Конечно, опять, смотрим данные сертификата, для проверки:

    <pre><code># openssl x509 -noout -text -in client01.crt</code></pre>

Подготовка данных для передачи клиенту.<br>

Для передачи сертификата лучше использовать файл в формате PKCS#12.<br>
В этот файл упаковывается и защищается паролем вся информация необходимая клиенту для установки сертификата.

    <pre><code># openssl pkcs12 -export -in client01.crt -inkey client01.key \
-certfile ca.crt -out client01.p12 -passout pass:password01</code></pre>
	
	
Всё, мо создали клиентский сертификат, и упаковали в его надёжный контейнер.<br>
Теперь его можнро легко устанавливать в браузер.<br>

Если упростить, то для создания новых клиентских сертификатов просто повторите 3 комманды (только client01 замените на новое имя):

1) Создаём ключ и сертификат:
    <pre><code># openssl req -new -newkey rsa:1024 -nodes -keyout client01.key \
-subj /C=RU/ST=Perm/L=Perm/O=MyOrg\ Inc/OU=Sale/CN=Ivan/emailAddress=mailadres@maximal.pro \
-out client01.csr</code></pre>
2) Подписываем сертификат
    <pre><code># openssl ca -config ca.config -in client01.csr -out client01.crt -batch</code></pre>
3) Упаковываем сертификат
    <pre><code># openssl pkcs12 -export -in client01.crt -inkey client01.key \
-certfile ca.crt -out client01.p12 -passout pass:password01</code></pre>

<h2>Настройка веб-сервера Apache.</h2>

Для авторизации по клиентским сертификатам необходимо:<br>
    1. Установить запрет доступа к защищаемой области по протоколу HTTP.<br>
    2. Включить запрос и проверка клиентских сертификатов.<br>
<br>

<h3>Запрет доступа к защищаемой области по протоколу HTTP.</h3>

Найдите в конфигурационном файле веб-сервера httpd.conf секцию &lt;VirtualHost IP-ADDRESS&gt;, соответсвующую вашему сайту и добавьте в неё следующие директивы:

<pre><code><Directory /path/to/secure/area/>
    SSLRequire
</Directory></code></pre>


<h3>Запрос и проверка клиентских сертификатов.</h3>

Находим в конфиге httpd.conf секцию, соответсвующую вашему сайту и добаляем(или разкоментируем):

<pre><code>SSLCACertificateFile /path/to/ca.crt
<Directory /path/to/secure/area/>
    SSLVerifyClient require
</Directory></code></pre>

Перегружаем сервер апача

<pre><code># apachectl restart</code></pre>

    
<h2>Отзыв сертификатов.</h2>

Отозвать сертфиикат клиента не так просто, но и не особо сложно.

<h3>Создание списка отзыва (CRL).</h3>

При создании списка отзыва используется тот же конфигурационный файл и таже структура файлов, что и при подписи сертификатов, поэтому при выполнении следующей команды вы должны находиться в том же каталоге.

<pre><code># openssl ca -gencrl -config ca.config -out ca.crl</code></pre>

В результате будет создан список отзыва, основанный на базе данных подписанных сертификатах db/index.txt.<br>
Так как на данный момент ни один из сертификатов в базе данных не помечен как отозванный, то созданный список будет пустым.<br>
Просмотреть данные списка отзыва вы можете с помощью следующей команды:

<pre><code># openssl crl -in ca.crl -text -noout</code></pre>


Одной из важных черт списка отзыва является его срок действия, указываемый в конфигурационном файле ca.config с помощью директивы default_crl_days.<br>
Также альтернативно может быть использована директива default_crl_hours, если вы планируете часто обновлять ваш CRL.<br>
Список отзыва должен обновляться не позже истечения срока действия.<br>
Для переодического вызова приведенной выше команды можно использовать cron.

<h3>Отзыв сертификата.</h3>

Для того чтобы отозвать клиентский сертификат необходимо пометить его в базе данных сертификатов db/index.txt как отозванный, тогда при следующем обновлении списка отзыва, этот сертификат будет в него включен. <br>
Для пометки сертификата как отозванного используйте приведенную ниже команду.

<pre><code># openssl ca -config ca.config -revoke client01.crt</code></pre>

<h3>Настройка веб-сервера</h3>

После создания списка отзыва сертификатов необходимо дать возможность веб-серверу использовать его.<br>
Для этого добавьте в конфигурационный файл веб-сервера:

<pre><code>SSLCARevocationFile /path/to/ca.crl</code></pre>

Не забываем перезапускать апач.

<pre><code># apachectl restart</code></pre>
